<ng-container *ngIf="initialLoadingCompleted">
  <div class="swiper-container h-100">
    <!-- Top gradient overlay and controls -->
    <div class="top-overlay">
      <!-- Progress bar -->
      <div 
        class="progress-bar-container"
        role="progressbar"
        [attr.aria-label]="'Step progress: ' + (swiperIndex + 1) + ' of ' + totalStepCount + ' steps'"
        [attr.aria-valuenow]="totalProgress"
        [attr.aria-valuemin]="0"
        [attr.aria-valuemax]="100">
        <div class="progress-segments">
          <div 
            *ngFor="let i of getSegmentIndices(); trackBy: trackByIndex" 
            class="progress-segment"
            [class.completed]="isStepCompleted(i)"
            [class.active]="i === swiperIndex"
            [class.upcoming]="i > swiperIndex"
            [class.last-page-segment]="i >= steps.length">
            <!-- Completed segments show full fill -->
            <div 
              class="segment-fill" 
              *ngIf="isStepCompleted(i)" 
              [style.width.%]="100">
            </div>
            <!-- Active segment shows current progress -->
            <div 
              class="segment-fill" 
              *ngIf="i === swiperIndex && !isStepCompleted(i)" 
              [style.width.%]="currentStepProgress"
              [attr.data-step]="swiperIndex">
            </div>
          </div>
        </div>
      </div>
      
      <!-- Top controls -->
      <div class="top-controls">
        <button
          *ngIf="hasAudio"
          class="audio-control circle-icon-button large dark transparent"
          (click)="onAudioBtnClicked()"
          type="button"
          [attr.aria-label]="'Toggle audio: currently ' + (isAudioMuted ? 'off' : 'on')"
          [attr.aria-pressed]="!isAudioMuted">
          <img *ngIf="!isAudioMuted" src="assets/svg/sound-on.svg" alt="sound-on"/>
          <img *ngIf="isAudioMuted" src="assets/svg/sound-off.svg" alt="sound-off"/>
        </button>
        <div class="controls-spacer"></div>
        <ng-container *ngIf="showCloseButton">
          <button class="circle-icon-button small dark transparent" type="button" (click)="close.emit()" aria-label="Close player">
            <img class="icon" src="assets/svg/close.svg" alt="Close"/>
          </button>
        </ng-container>
      </div>
    </div>

    <div class="swiper-wrapper">
      <div class="swiper-slide"
        *ngFor="
          let step of steps;
          let i = index;
        ">
        <div class="d-flex h-100 w-100">
          <sim-step-slide
            #slide
            [simpiId]="simpi?.simpiId"
            [step]="step"
            [voiceOverLanguage]="language"
            [width]="width"
            [height]="height"
            [scaleStrategy]="scaleStrategy"
            [title]="translatedTitle(step) | async"
            [active]="i === swiperIndex && !showInfoOverlay"
            (videoPlayError)="onVideoPlayError($event)">
          </sim-step-slide>
        </div>
      </div>
      <div class="swiper-slide last-slide">
        <div class="d-flex h-100 w-100">
          <sim-last-slide>
            <div class="last-slide-slider w-100 h-100 text-left">
              <ng-container *ngIf="relatedSimpis$ | async as simpis">
                <div #lastSlider class="swiper-container h-100">
                  <div class="swiper-wrapper">
                    <div *ngFor="let simpi of simpis" class="swiper-slide">
                      <div class="d-flex flex-column w-100" (click)="selectRelatedSimpi(simpi)">
                        <div class="last-slide-item-img">
                          <img [src]="simpi.thumbnailUrl"/>
                        </div>
                        <div class="last-slide-item-text">
                          <div class="title">
                            {{ simpi.title }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
            </div>
            <div class="action-buttons-slot d-flex flex-column">
              <button class="btn btn-outline-primary" (click)="repeatSimpi()">
                Repeat
              </button>
              <button class="btn btn-outline-primary" (click)="share.emit()">
                Share with Friends
              </button>
            </div>
          </sim-last-slide>
        </div>
      </div>
    </div>
    <!-- Desktop navigation buttons only -->
    <div class="desktop-navigation" *ngIf="!showInfoOverlay">
      <div class="nav-left">
        <!-- Previous button: show on last step or if not on first step -->
        <button 
          class="swiper-button-prev circle-icon-button small dark transparent" 
          type="button" 
          (click)="prevSlide()"
          [attr.aria-label]="'Previous step'"
          [attr.aria-disabled]="swiperIndex === 0"
          *ngIf="swiperIndex > 0 || swiperIndex === steps.length">
          <img class="prev-slide-icon" src="assets/svg/navigation-arrow.svg" alt="Previous"/>
        </button>
      </div>
      <div class="nav-right">
        <!-- Next button: show after start pressed and not on last page -->
        <button
          class="swiper-button-next circle-icon-button small dark transparent"
          type="button"
          (click)="nextSlide()"
          [attr.aria-label]="'Next step'"
          [attr.aria-disabled]="swiperIndex >= steps.length"
          *ngIf="swiperIndex < steps.length">
          <img class="next-slide-icon" src="assets/svg/navigation-arrow.svg" alt="Next"/>
        </button>
      </div>
    </div>
  </div>
  <sim-overlay #overlay [simpi]="simpi" [visible]="showInfoOverlay" [resources]="resources" [resourceButtonTemplate]="resourceButtonTemplate">
    <button
      class="start-btn btn btn-block"
      (click)="playSimpi()"
      [disabled]="!currentSlide?.loaded"
    >
      <img class="caret-icon" src="assets/svg/play.svg" alt="Play simpi button"/>START
    </button>
  </sim-overlay>
  <audio id="stepAudio" #audio (ended)="onAudioEnded()" style="display: none"></audio>
</ng-container>

<ng-container *ngIf="!initialLoadingCompleted">
  <sim-loading-spinner [show]="true"></sim-loading-spinner>
</ng-container>

<ng-template #resourceButtonTemplate let-resource>
  <button
    *ngIf="resource.shoppingLink"
    class="btn detail-btn background-theme-primary-color border-theme-primary-color"
    (click)="openShoppingLink(resource.shoppingLink)"
  >
    {{ resource.resourceType === resourceType.Product ? "Shop" : "Details" }}
  </button>
</ng-template>
